# 🎉 日志系统升级完成

## ✅ 完成的工作

### 1. 添加依赖
在 `src-tauri/Cargo.toml` 中添加了：
- `tracing = "0.1"` - 核心日志框架
- `tracing-subscriber = "0.3"` - 日志订阅器（支持环境过滤、JSON、本地时间）
- `tracing-appender = "0.2"` - 日志文件滚动

### 2. 替换所有 `println!` 为结构化日志

| 旧代码 | 新代码 | 用途 |
|--------|--------|------|
| `println!("✅ xxx")` | `info!("xxx")` | 一般信息 |
| `println!("⚠️ xxx")` | `warn!("xxx")` | 警告信息 |
| `println!("❌ xxx")` | `error!("xxx")` | 错误信息 |
| `println!("📄 xxx")` | `debug!("xxx")` | 调试信息 |
| `eprintln!("xxx")` | `error!("xxx")` | 错误到 stderr |

### 3. 添加函数级别追踪

使用 `#[instrument]` 宏为关键函数添加自动追踪：
- `get_sources()` - 获取订阅源列表
- `add_source()` - 添加订阅源
- `update_source()` - 更新订阅源
- `delete_source()` - 删除订阅源
- `create_proxy_url()` - 创建代理 URL
- `proxy_stream()` - 代理流请求
- `fetch_url_content()` - 获取 URL 内容
- `fetch_and_proxy_m3u8()` - 获取并处理 m3u8
- `fetch_and_parse_m3u()` - 下载并解析 M3U
- `proxy_handler()` - HTTP 代理处理
- `start_proxy_server()` - 启动代理服务器
- `handle_stream_protocol()` - Stream protocol 处理

### 4. 实现双输出日志系统

#### 文件日志
- **位置**:
  - macOS: `~/Library/Logs/com.sai.iptv-player/iptv-player.log`
  - Windows: `%APPDATA%\com.sai.iptv-player\logs\iptv-player.log`
  - Linux: `~/.local/share/com.sai.iptv-player/logs/iptv-player.log`
- **特点**:
  - 包含完整信息（时间戳、模块、线程 ID、行号）
  - 每日自动滚动（午夜创建新文件）
  - 无 ANSI 颜色代码
  - 适合事后分析和问题排查

#### 控制台日志
- **位置**: stdout
- **特点**:
  - 带 ANSI 颜色高亮
  - 紧凑格式，易于实时查看
  - 可通过终端启动应用查看

### 5. 支持环境变量配置

通过 `RUST_LOG` 环境变量控制日志级别：

```bash
# 显示所有 INFO 及以上级别（默认）
export RUST_LOG=info

# 显示所有 DEBUG 及以上级别
export RUST_LOG=debug

# 仅显示应用代码的 DEBUG，依赖库显示 WARN
export RUST_LOG=tauri_app_lib=debug,warn

# 仅显示错误
export RUST_LOG=error

# 最详细的日志
export RUST_LOG=trace
```

---

## 📊 日志示例

### 应用启动
```
2025-10-26T10:30:45.123456Z  INFO tauri_app_lib: ========================================
2025-10-26T10:30:45.123789Z  INFO tauri_app_lib: IPTV Player 启动
2025-10-26T10:30:45.123890Z  INFO tauri_app_lib: 版本: 0.1.0
2025-10-26T10:30:45.124012Z  INFO tauri_app_lib: ========================================
2025-10-26T10:30:45.124234Z  INFO tauri_app_lib: 启动 HTTP 代理服务器: http://127.0.0.1:18080
2025-10-26T10:30:45.234567Z  INFO tauri_app_lib: 数据目录: "/Users/sai/Library/Application Support/com.sai.iptv-player"
2025-10-26T10:30:45.234789Z  INFO tauri_app_lib: 日志系统初始化完成
2025-10-26T10:30:45.234890Z  INFO tauri_app_lib: 日志文件位置: "/Users/sai/Library/Logs/com.sai.iptv-player/iptv-player.log"
2025-10-26T10:30:45.345678Z  INFO tauri_app_lib: 从文件加载了 3 个订阅源
2025-10-26T10:30:45.345890Z  INFO tauri_app_lib: 应用初始化完成
```

### 添加订阅源
```
2025-10-26T10:31:00.123456Z  INFO tauri_app_lib::add_source: 添加订阅源: 名称='CCTV 频道', URL类型='网络地址'
2025-10-26T10:31:00.234567Z DEBUG tauri_app_lib::fetch_and_parse_m3u: 下载 M3U 播放列表
2025-10-26T10:31:01.345678Z  INFO tauri_app_lib::fetch_and_parse_m3u: M3U 内容下载成功，大小: 12345 字节
2025-10-26T10:31:01.456789Z  INFO tauri_app_lib::parse_m3u_content: 成功解析 123 个频道
2025-10-26T10:31:01.567890Z  INFO tauri_app_lib::add_source: 订阅源 'CCTV 频道' 添加成功！当前总数: 4
2025-10-26T10:31:01.678901Z  INFO tauri_app_lib::AppState::save_sources: 数据已保存到: "/Users/sai/Library/Application Support/com.sai.iptv-player/sources.json", 数量: 4
```

### HTTP 代理请求
```
2025-10-26T10:32:00.123456Z DEBUG tauri_app_lib::proxy_handler: HTTP 代理请求: http://[2001:db8::1]:8080/playlist.m3u8
2025-10-26T10:32:00.234567Z DEBUG tauri_app_lib::proxy_handler: 处理 m3u8 内容，原始大小: 5678 字节
2025-10-26T10:32:00.345678Z DEBUG tauri_app_lib::proxy_handler: m3u8 处理完成，重写了 12 个 IPv6 URL，新大小: 6789 字节
2025-10-26T10:32:00.456789Z  INFO tauri_app_lib::proxy_handler: HTTP 代理成功: 6789 字节, 类型: application/vnd.apple.mpegurl
```

### 错误示例
```
2025-10-26T10:33:00.123456Z ERROR tauri_app_lib::fetch_and_parse_m3u: 下载失败: connection refused
2025-10-26T10:33:10.234567Z  WARN tauri_app_lib::delete_source: 未找到要删除的订阅源: ID=invalid-id
2025-10-26T10:33:20.345678Z ERROR tauri_app_lib::AppState::load_sources: 解析 JSON 失败: unexpected end of file at line 1 column 0
```

---

## 🚀 快速测试

### 1. 编译测试
```bash
cd /Users/sai/good_tool/tauri-iptv-player/src-tauri
cargo check
```

### 2. 运行开发版本（可看到控制台日志）
```bash
cd /Users/sai/good_tool/tauri-iptv-player
npm run tauri dev
```

### 3. 打包生产版本
```bash
cd /Users/sai/good_tool/tauri-iptv-player
npm run tauri build
```

### 4. 测试日志文件
安装并运行应用后：
```bash
# 查看日志文件是否创建
ls -lh ~/Library/Logs/com.sai.iptv-player/

# 实时查看日志
tail -f ~/Library/Logs/com.sai.iptv-player/iptv-player.log

# 搜索特定内容
grep "INFO" ~/Library/Logs/com.sai.iptv-player/iptv-player.log
grep "ERROR\|WARN" ~/Library/Logs/com.sai.iptv-player/iptv-player.log
```

### 5. 测试不同日志级别
```bash
# 设置为 DEBUG 级别
export RUST_LOG=debug
npm run tauri dev

# 设置为 TRACE 级别（最详细）
export RUST_LOG=trace
npm run tauri dev

# 仅显示错误
export RUST_LOG=error
npm run tauri dev
```

---

## 📚 详细文档

完整的日志使用指南请查看：[LOGGING.md](./LOGGING.md)

包含以下内容：
- 📁 各平台日志文件位置
- 🔍 查看日志的多种方法
- 📊 日志级别说明
- ⚙️ 配置日志级别
- 📋 高级过滤技巧
- 🔧 调试技巧
- 📤 报告问题时如何导出日志
- 🔄 日志滚动和清理
- ❓ 常见问题

---

## 🎯 关键优势

### 相比之前的 `println!`

| 特性 | println! | tracing |
|------|----------|---------|
| 日志级别 | ❌ 无 | ✅ 5 个级别 |
| 文件输出 | ❌ 无 | ✅ 自动写入文件 |
| 时间戳 | ❌ 无 | ✅ 精确到微秒 |
| 模块信息 | ❌ 无 | ✅ 自动记录 |
| 行号 | ❌ 无 | ✅ 自动记录 |
| 线程 ID | ❌ 无 | ✅ 自动记录 |
| 函数追踪 | ❌ 无 | ✅ 自动追踪 |
| 环境控制 | ❌ 无 | ✅ RUST_LOG |
| 日志滚动 | ❌ 无 | ✅ 每日滚动 |
| 结构化 | ❌ 无 | ✅ 键值对 |
| 过滤 | ❌ 无 | ✅ 按模块/级别 |

---

## 🔍 生产环境使用建议

1. **默认级别**: `INFO` - 记录关键操作，不会太冗长
2. **调试问题**: `DEBUG` - 可以看到详细的执行流程
3. **性能分析**: `TRACE` - 最详细，会影响性能
4. **发布版本**: `WARN` 或 `ERROR` - 仅记录问题

### 环境变量设置（生产环境）

**macOS 用户全局配置：**
```bash
# 添加到 ~/.zshrc 或 ~/.bashrc
echo 'export RUST_LOG=info' >> ~/.zshrc
source ~/.zshrc
```

**Windows 系统环境变量：**
```powershell
[System.Environment]::SetEnvironmentVariable("RUST_LOG", "info", "User")
```

---

## 📝 后续优化建议

1. **日志归档**: 添加自动删除 30 天前的日志
2. **性能监控**: 使用 `tracing-timing` 记录函数耗时
3. **远程日志**: 集成 Sentry 或其他错误追踪服务
4. **结构化查询**: 使用 JSON 格式便于日志分析工具处理
5. **日志压缩**: 自动压缩旧日志文件节省空间

---

**更新日期**: 2025-10-26
**版本**: 0.1.0
**更新人**: AI Assistant
