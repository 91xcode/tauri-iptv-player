# 🚀 自动发布指南

## 快速开始

使用自动发布脚本，一键完成版本更新、提交、打 Tag 和推送：

```bash
./release.sh
```

## 📋 脚本功能

自动化发布脚本会完成以下所有步骤：

1. ✅ 检查代码更改
2. ✅ 读取当前版本号
3. ✅ 选择版本更新类型（Patch/Minor/Major/Custom）
4. ✅ 输入更新说明
5. ✅ 更新 3 个文件的版本号
   - `package.json`
   - `src-tauri/Cargo.toml`
   - `src-tauri/tauri.conf.json`
6. ✅ 提交代码到 Git
7. ✅ 创建 Git Tag
8. ✅ 推送代码和 Tag 到 GitHub
9. ✅ 触发 GitHub Actions 自动构建

## 🎯 使用场景

### 场景1：修复 Bug（Patch）

```bash
# 1. 修改代码，修复 bug
# 2. 运行脚本
./release.sh

# 3. 选择版本类型
请选择 [1-4] (默认: 1): 1  # Patch: 0.2.7 → 0.2.8

# 4. 输入更新说明
修复播放器崩溃问题
.

# 5. 确认发布
确认发布？[y/N]: y
```

### 场景2：添加新功能（Minor）

```bash
./release.sh

请选择 [1-4] (默认: 1): 2  # Minor: 0.2.7 → 0.3.0

添加播放历史记录功能
支持自动清晰度切换
.

确认发布？[y/N]: y
```

### 场景3：重大更新（Major）

```bash
./release.sh

请选择 [1-4] (默认: 1): 3  # Major: 0.2.7 → 1.0.0

正式版发布
完全重构播放引擎
.

确认发布？[y/N]: y
```

### 场景4：自定义版本号

```bash
./release.sh

请选择 [1-4] (默认: 1): 4  # Custom

请输入新版本号 (格式: x.y.z): 2.0.0-beta.1

Beta 测试版
.

确认发布？[y/N]: y
```

## 📝 版本号规范

遵循语义化版本（Semantic Versioning）：

```
主版本号.次版本号.修订号
MAJOR.MINOR.PATCH
```

### 何时增加版本号？

| 版本类型 | 何时使用 | 示例 |
|---------|---------|------|
| **Patch** | Bug 修复、小改进 | `0.2.7 → 0.2.8` |
| **Minor** | 新功能、向后兼容 | `0.2.7 → 0.3.0` |
| **Major** | 重大更新、不兼容 | `0.2.7 → 1.0.0` |

## 🎨 脚本特性

### 颜色输出

- 🔴 红色：错误信息
- 🟢 绿色：成功信息
- 🟡 黄色：提示信息
- 🔵 蓝色：信息展示

### 智能检测

- ✅ 自动检测是否有代码更改
- ✅ 自动读取当前版本号
- ✅ 版本号格式验证
- ✅ Git 状态检查

### 安全保护

- ✅ 每次发布前需要确认
- ✅ 版本号格式验证
- ✅ 错误立即退出（`set -e`）

## 📦 发布流程详解

```
┌─────────────────────────────────────────────────┐
│  1. 修改代码                                     │
│     - 修复 Bug / 添加功能                        │
│     - 更新文档                                   │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  2. 运行 ./release.sh                           │
│     - 检查代码更改 ✓                            │
│     - 读取当前版本                               │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  3. 选择版本类型                                 │
│     - Patch (0.2.7 → 0.2.8)                     │
│     - Minor (0.2.7 → 0.3.0)                     │
│     - Major (0.2.7 → 1.0.0)                     │
│     - Custom (自定义)                           │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  4. 输入更新说明                                 │
│     - 多行输入支持                               │
│     - 按 . 结束输入                              │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  5. 确认发布                                     │
│     - 显示版本摘要                               │
│     - 输入 y 确认                                │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  6. 自动化执行                                   │
│     - 更新 3 个文件版本号 ✓                      │
│     - Git 提交 ✓                                │
│     - 创建 Tag ✓                                │
│     - 推送到 GitHub ✓                           │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  7. GitHub Actions 自动构建                      │
│     - 4 个平台并行构建                           │
│     - 生成 6 个安装包                            │
│     - 自动创建 Release                           │
│     - 预计时间: 5-8 分钟                         │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  8. 发布完成 ✅                                  │
│     - Release 页面可下载                         │
│     - 6 个平台安装包就绪                         │
└─────────────────────────────────────────────────┘
```

## 🔧 手动发布（不推荐）

如果需要手动发布，按以下步骤：

```bash
# 1. 更新版本号
vim package.json  # 修改 version
vim src-tauri/Cargo.toml  # 修改 version
vim src-tauri/tauri.conf.json  # 修改 version

# 2. 提交代码
git add -A
git commit -m "release: v0.2.8"
git push

# 3. 创建 Tag
git tag -a v0.2.8 -m "Release v0.2.8"
git push origin v0.2.8

# 4. 等待 GitHub Actions 构建
```

**不推荐原因**：
- ❌ 容易漏掉文件
- ❌ 版本号可能不一致
- ❌ 容易出错
- ❌ 重复劳动

## 💡 提示和技巧

### 1. 多行输入更新说明

```bash
输入本次更新说明:

修复混合内容问题
添加 DevTools 支持
优化播放性能
.  ← 输入点号结束
```

### 2. 快速确认

```bash
# 如果只想快速发布，所有提示都按默认值：
./release.sh
# 直接回车 × 2 → 输入说明 → y 确认
```

### 3. 查看脚本执行过程

脚本会实时显示每个步骤的执行状态，带颜色标识：

- ✅ 绿色勾：成功
- ❌ 红色叉：错误
- 📦 黄色：进行中

### 4. 取消发布

在任何确认步骤，输入 `n` 或 `Ctrl+C` 即可取消。

## 🚨 常见问题

### Q: 脚本提示"没有检测到任何更改"

**A**: 先修改代码，然后再运行脚本。脚本会自动检测 Git 状态。

### Q: 版本号冲突

**A**: 确保选择的新版本号大于当前版本。

### Q: 推送失败

**A**: 检查网络连接和 Git 权限。

### Q: GitHub Actions 构建失败

**A**: 访问 Actions 页面查看具体错误日志。

## 📚 相关文档

- [README.md](README.md) - 项目主文档
- [BUILD_GUIDE.md](BUILD_GUIDE.md) - 构建指南
- [INSTALL_MACOS.md](INSTALL_MACOS.md) - macOS 安装说明

## 🎉 示例输出

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          🚀 IPTV Player 自动发布脚本
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 检查 Git 状态...
✅ 检测到代码更改
M  src/App.tsx
M  src/components/VideoPlayer.tsx

📦 读取当前版本...
当前版本: v0.2.7

🔢 选择版本更新类型:
  1) Patch  (Bug 修复)    0.2.7 → 0.2.8
  2) Minor  (新功能)      0.2.7 → 0.3.0
  3) Major  (重大更新)    0.2.7 → 1.0.0
  4) Custom (自定义版本)

请选择 [1-4] (默认: 1): 1

✅ 新版本: v0.2.8

📝 输入本次更新说明:
提示: 按回车结束输入，输入 '.' 单独一行表示多行输入结束

修复播放器卡顿问题
优化内存占用
.

更新说明:
修复播放器卡顿问题
优化内存占用

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 发布摘要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  当前版本: v0.2.7
  新版本:   v0.2.8
  更新类型: patch
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

确认发布？[y/N]: y

🚀 开始发布流程...

📝 更新版本号...
  ✓ package.json
  ✓ src-tauri/Cargo.toml
  ✓ src-tauri/tauri.conf.json
✅ 版本号更新完成

📦 提交代码到 Git...
✅ 代码已提交

🏷️  创建 Git Tag...
✅ Tag v0.2.8 已创建

☁️  推送到 GitHub...
✅ 代码已推送
✅ Tag 已推送

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          ✅ 发布成功！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📦 版本: v0.2.8
🏷️  Tag:  v0.2.8

🚀 GitHub Actions 正在构建...
⏱️  预计时间: 5-8 分钟

🔗 查看进度:
   https://github.com/91xcode/tauri-iptv-player/actions

📦 Release 页面:
   https://github.com/91xcode/tauri-iptv-player/releases/tag/v0.2.8

预期产物（6个文件）:
  1️⃣  IPTV-Player-v0.2.8-macOS-Apple-Silicon.dmg
  2️⃣  IPTV-Player-v0.2.8-macOS-Intel.dmg
  3️⃣  IPTV-Player-v0.2.8-Windows-x64.msi
  4️⃣  IPTV-Player-v0.2.8-Windows-x64-setup.exe
  5️⃣  IPTV-Player-v0.2.8-Linux-x64.deb
  6️⃣  IPTV-Player-v0.2.8-Linux-x64.AppImage

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```
