# IPTV Player ä¿®å¤æ€»ç»“ v2.0

## ğŸ¯ é—®é¢˜æè¿°

æ’­æ”¾ IPv6 ç›´æ’­æµæ—¶ï¼Œ**æ’­æ”¾åˆ° 1 åˆ†é’Ÿåè‡ªåŠ¨åœæ­¢**ã€‚

## ğŸ” æ ¹æœ¬åŸå› 

### åŸå§‹å®ç°çš„é—®é¢˜

```typescript
// âŒ é”™è¯¯çš„å®ç°æ–¹å¼
1. ä¸‹è½½ IPv6 m3u8 æ–‡ä»¶ï¼ˆä¸€æ¬¡æ€§ï¼‰
2. è½¬æ¢æ‰€æœ‰ URL ä¸ºä»£ç† URL
3. åˆ›å»º Blob URL
4. ä¼ ç»™ HLS.js

é—®é¢˜ï¼šBlob URL æ˜¯é™æ€çš„ï¼Œä¸ä¼šæ›´æ–°ï¼
ç›´æ’­æµçš„ m3u8 éœ€è¦å®šæœŸåˆ·æ–°è·å–æ–°çš„ç‰‡æ®µã€‚
```

### é¢å¤–çš„å¹²æ‰°å› ç´ 

```typescript
// âŒ æ’­æ”¾ç›‘æ§å™¨ï¼ˆæ¯ 5 ç§’æ‰§è¡Œï¼‰
- æ£€æµ‹æ’­æ”¾æ˜¯å¦å¡ä½ â†’ è°ƒç”¨ hls.startLoad() â†’ é‡æ–°åŠ è½½æ•´ä¸ªæµ
- æ£€æµ‹å»¶è¿Ÿè¶…è¿‡ 30 ç§’ â†’ å¼ºåˆ¶è·³è½¬ currentTime â†’ è§¦å‘ç¼“å†²åŒºé‡ç½®
```

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å®Œå…¨å‚è€ƒ x-iptv-player çš„å®ç°

**x-iptv-player (Electron) çš„åšæ³•ï¼š**
- ç›´æ¥å°† URL ä¼ ç»™ HLS.js
- åœ¨ Node.js ä»£ç†æœåŠ¡å™¨ä¸­é‡å†™ m3u8 å†…å®¹
- ä¸å¹²é¢„æ’­æ”¾è¿‡ç¨‹ï¼Œè®© HLS.js è‡ªå·±å¤„ç†

**æˆ‘ä»¬çš„å®ç°ï¼ˆTauriï¼‰ï¼š**
- å‰ç«¯ï¼šç›´æ¥ä¼ ä»£ç† URL ç»™ HLS.js
- åç«¯ï¼šAxum ä»£ç†æœåŠ¡å™¨é‡å†™ m3u8 å†…å®¹
- ä¸å¹²é¢„æ’­æ”¾è¿‡ç¨‹

### 2. å‰ç«¯ä¿®æ”¹

#### ä¹‹å‰ï¼ˆâŒ é”™è¯¯ï¼‰ï¼š
```typescript
// ä¸‹è½½ m3u8
const content = await invoke("fetch_and_proxy_m3u8", { url });

// æ‰‹åŠ¨é‡å†™ URL
const processedLines = content.split('\n').map(...);

// åˆ›å»º Blob URLï¼ˆé™æ€ï¼ï¼‰
const blob = new Blob([processedContent], { type: "..." });
const blobUrl = URL.createObjectURL(blob);

// ä¼ ç»™ HLS.js
hls.loadSource(blobUrl);
```

#### ç°åœ¨ï¼ˆâœ… æ­£ç¡®ï¼‰ï¼š
```typescript
// ç›´æ¥ä½¿ç”¨ä»£ç† URLï¼ˆåŠ¨æ€ï¼ï¼‰
if (isIpv6 && channel.url.includes(".m3u8")) {
  const encodedUrl = encodeURIComponent(channel.url);
  processedUrl = `http://127.0.0.1:18080/proxy?url=${encodedUrl}`;
}

// ä¼ ç»™ HLS.js
hls.loadSource(processedUrl);
```

### 3. åç«¯ä¿®æ”¹

åœ¨ Rust ä»£ç†æœåŠ¡å™¨ä¸­æ·»åŠ  m3u8 é‡å†™é€»è¾‘ï¼š

```rust
// src-tauri/src/lib.rs
async fn proxy_handler(Query(params): Query<ProxyParams>) -> Result<Response, StatusCode> {
    // è·å–åŸå§‹å†…å®¹
    let bytes = response.bytes().await?;

    // â­ å¦‚æœæ˜¯ m3u8ï¼Œé‡å†™å†…å®¹
    let final_bytes = if params.url.contains(".m3u8") {
        let content = String::from_utf8(bytes.to_vec())?;

        // è§£æ base URL
        let base_url = extract_base_url(&params.url);

        // é‡å†™æ¯ä¸€è¡Œ
        let processed_lines: Vec<String> = content.lines().map(|line| {
            if line.starts_with('#') || line.is_empty() {
                return line.to_string();
            }

            // ç›¸å¯¹è·¯å¾„ â†’ ç»å¯¹è·¯å¾„
            let absolute_url = make_absolute(line, base_url);

            // â­ IPv6 URL â†’ ä»£ç† URL
            if absolute_url.contains('[') && absolute_url.contains(']') {
                let encoded = urlencoding::encode(&absolute_url);
                format!("http://127.0.0.1:18080/proxy?url={}", encoded)
            } else {
                absolute_url
            }
        }).collect();

        processed_lines.join("\n").into_bytes()
    } else {
        bytes.to_vec()
    };

    Ok(response)
}
```

### 4. ç§»é™¤æ’­æ”¾ç›‘æ§

```typescript
// âŒ åˆ é™¤
const startProgressMonitor = () => {
  progressCheckIntervalRef.current = window.setInterval(() => {
    // æ£€æŸ¥å¡ä½ã€å»¶è¿Ÿç­‰ â†’ å¹²é¢„æ’­æ”¾
  }, 5000);
};

// âœ… è®© HLS.js è‡ªå·±å¤„ç†
// ä¸éœ€è¦ä»»ä½•ç›‘æ§é€»è¾‘
```

### 5. ä¼˜åŒ– HLS.js é…ç½®

```typescript
const hls = new Hls({
  // è¶…æ—¶é…ç½®ï¼ˆå¤§å¹…å¢åŠ ï¼‰
  fragLoadingTimeOut: 60000,        // 60 ç§’
  manifestLoadingTimeOut: 30000,    // 30 ç§’
  levelLoadingTimeOut: 30000,       // 30 ç§’

  // é‡è¯•é…ç½®ï¼ˆå¢åŠ æ¬¡æ•°ï¼‰
  manifestLoadingMaxRetry: 6,       // 6 æ¬¡
  levelLoadingMaxRetry: 6,          // 6 æ¬¡
  fragLoadingMaxRetry: 8,           // 8 æ¬¡

  // Buffer é…ç½®ï¼ˆå¤§å®¹é‡ï¼‰
  maxBufferLength: 30,              // 30 ç§’
  maxMaxBufferLength: 60,           // 60 ç§’
  backBufferLength: 30,             // 30 ç§’
  maxBufferSize: 120 * 1000 * 1000, // 120 MB

  // ç¨³å®šæ€§ä¼˜å…ˆ
  lowLatencyMode: false,            // å…³é—­ä½å»¶è¿Ÿæ¨¡å¼
});
```

### 6. æ™ºèƒ½é”™è¯¯å¤„ç†

```typescript
hls.on(Hls.Events.ERROR, (_event, data) => {
  // â­ æ™ºèƒ½è¿‡æ»¤ï¼šå¿½ç•¥éè‡´å‘½é”™è¯¯
  const ignorableErrors = [
    'fragLoadError',
    'fragLoadTimeOut',
    'levelLoadTimeOut',
    // ...
  ];

  if (!data.fatal && ignorableErrors.includes(data.details)) {
    return; // è®© HLS.js è‡ªåŠ¨å¤„ç†
  }

  // åªå¤„ç†è‡´å‘½é”™è¯¯
  if (data.fatal) {
    // æŒ‡æ•°é€€é¿é‡è¯•
    const delay = Math.min(1000 * Math.pow(2, retryCount), 10000);
    setTimeout(() => {
      if (data.type === 'NETWORK_ERROR') {
        hls.startLoad();
      } else if (data.type === 'MEDIA_ERROR') {
        hls.recoverMediaError();
      }
    }, delay);
  }
});
```

## ğŸ¬ å·¥ä½œæµç¨‹å¯¹æ¯”

### ä¹‹å‰ï¼ˆâŒï¼‰ï¼š
```
1. å‰ç«¯è¯·æ±‚ Tauri å‘½ä»¤ä¸‹è½½ m3u8
   â†“
2. Tauri ä¸‹è½½ m3u8 è¿”å›ç»™å‰ç«¯
   â†“
3. å‰ç«¯é‡å†™ URLï¼Œåˆ›å»º Blob
   â†“
4. HLS.js åŠ è½½ Blob URLï¼ˆé™æ€ï¼Œä¸ä¼šæ›´æ–°ï¼‰
   â†“
5. âŒ æ’­æ”¾ 1 åˆ†é’Ÿååœæ­¢ï¼ˆm3u8 æ²¡æœ‰æ–°ç‰‡æ®µï¼‰
```

### ç°åœ¨ï¼ˆâœ…ï¼‰ï¼š
```
1. å‰ç«¯ç›´æ¥ä¼ ä»£ç† URL ç»™ HLS.js
   â†“
2. HLS.js è¯·æ±‚: http://127.0.0.1:18080/proxy?url=åŸå§‹m3u8
   â†“
3. Rust ä»£ç†æœåŠ¡å™¨è·å– m3u8
   â†“
4. é‡å†™å†…å®¹ï¼ˆæ‰€æœ‰ URL â†’ ä»£ç† URLï¼‰
   â†“
5. è¿”å›å¤„ç†åçš„ m3u8 ç»™ HLS.js
   â†“
6. HLS.js è§£æï¼Œè¯·æ±‚ .ts ç‰‡æ®µï¼ˆä¹Ÿé€šè¿‡ä»£ç†ï¼‰
   â†“
7. HLS.js å®šæ—¶åˆ·æ–° m3u8ï¼ˆè·å–æ–°ç‰‡æ®µï¼‰
   â†“
8. âœ… æŒç»­ç¨³å®šæ’­æ”¾ï¼ˆæ— æ—¶é—´é™åˆ¶ï¼‰
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **æ’­æ”¾æ—¶é•¿** | ~1 åˆ†é’Ÿ | âœ… æ— é™åˆ¶ |
| **m3u8 åˆ·æ–°** | âŒ é™æ€ Blob | âœ… åŠ¨æ€æ›´æ–° |
| **é”™è¯¯æ¢å¤** | âŒ åŸºç¡€ | âœ… æ™ºèƒ½è¿‡æ»¤ + æŒ‡æ•°é€€é¿ |
| **ç¼“å†²åŒº** | 10 ç§’ | 30-60 ç§’ |
| **è¶…æ—¶æ—¶é—´** | 20 ç§’ | 60 ç§’ |
| **é‡è¯•æ¬¡æ•°** | 4 æ¬¡ | 6-8 æ¬¡ |

## ğŸ”‘ å…³é”®ä»£ç ä½ç½®

### å‰ç«¯
- **VideoPlayer.tsx (61-75 è¡Œ)**: IPv6 URL å¤„ç†
- **VideoPlayer.tsx (140-175 è¡Œ)**: HLS.js é…ç½®
- **VideoPlayer.tsx (260-320 è¡Œ)**: é”™è¯¯å¤„ç†

### åç«¯
- **lib.rs (490-580 è¡Œ)**: ä»£ç†æœåŠ¡å™¨å®ç°
- **lib.rs (545-575 è¡Œ)**: m3u8 URL é‡å†™é€»è¾‘
- **lib.rs (590-600 è¡Œ)**: ä»£ç†æœåŠ¡å™¨å¯åŠ¨

## ğŸ“ æŠ€æœ¯è¦ç‚¹

1. **åŠ¨æ€ vs é™æ€ URL**
   - Blob URLï¼šé™æ€ï¼Œé€‚åˆä¸€æ¬¡æ€§èµ„æº
   - ä»£ç† URLï¼šåŠ¨æ€ï¼ŒHLS.js ä¼šå®šæ—¶åˆ·æ–°

2. **ä¸è¦å¹²é¢„ HLS.js**
   - HLS.js æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
   - è¿‡åº¦ç›‘æ§åè€Œä¼šå¯¼è‡´é—®é¢˜

3. **ä»£ç†æœåŠ¡å™¨çš„å…³é”®ä½œç”¨**
   - é‡å†™ m3u8 å†…å®¹ï¼ˆURL è½¬æ¢ï¼‰
   - æ³¨å…¥è¯·æ±‚å¤´ï¼ˆUser-Agentã€CORS ç­‰ï¼‰
   - æ”¯æŒ IPv6ï¼ˆReqwest è‡ªåŠ¨å¤„ç†ï¼‰

4. **æŒ‡æ•°é€€é¿é‡è¯•**
   - é¿å…é¢‘ç¹é‡è¯•å¯¼è‡´æœåŠ¡å™¨å‹åŠ›
   - ç»™ç½‘ç»œé—®é¢˜æ¢å¤çš„æ—¶é—´

## ğŸ“š å‚è€ƒèµ„æ–™

- [x-iptv-player](https://github.com/xxx/x-iptv-player) - ä¸»è¦å‚è€ƒé¡¹ç›®
- [HLS.js æ–‡æ¡£](https://github.com/video-dev/hls.js/blob/master/docs/API.md)
- [Axum å®˜æ–¹ç¤ºä¾‹](https://github.com/tokio-rs/axum/tree/main/examples)

---

**ä¿®å¤æ—¥æœŸï¼š** 2025-01-25
**ä¿®å¤ç‰ˆæœ¬ï¼š** v1.1.0
